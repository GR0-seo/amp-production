import os
import argparse
from bs4 import BeautifulSoup

def main():
    parser = argparse.ArgumentParser()

    parser.add_argument('--client')
    parser.add_argument('-i')
    parser.add_argument('--user')
    args = parser.parse_args()

    dest_folder = './' + args.client

    os.system('mkdir ' + args.client)  # make client directory
    os.system(r'scp -i ' + args.i + ' ' + args.user + '@34.73.69.180:/var/www/html/' + args.client + r'/\*.html ' + dest_folder)  # pull all files from server
    return
    ignore_files = [
        '_0.1.pre.html',
        '_1.pre.html',
        '_1.0.pre.html',
        '_1.1.0.pre.html',
        '_1.1.pre.html',
        '_1.2.pre.html',
        '_1.3.pre.html',
        '_1.4.pre.html',
        '_2.pre.html',
        '_3.pre.html',
        '_3.1.pre.html',
        '_4.pre.html',
        '_5.pre.html',
        '_6.pre.html',
        '_7.pre.html',
        '_8.pre.html',
        '_9.pre.html',
        '_10.pre.html',
        '_10.1.pre.html',
        '_10.2.pre.html',
        '_11.pre.html',
        '_13.pre.html',
        '_14.pre.html',
        '_14.2.pre.html',
        '_14.2.0.pre.html',
        '_14.2.1.pre.html',
        '_14.3.pre.html',
        '_14.4.pre.html',
        '_14.5.pre.html',
        '_14.6.pre.html',
        '_14.7.pre.html',
        '_14.8.pre.html',
        '_14.9.pre.html',
        '_15.pre.html',
        '_16.pre.html',
        '_16.0.pre.html',
        '_16.1.pre.html',
        '_16.2.pre.html',
        '_16.3.pre.html',
        '_16.4.pre.html',
        '_16.5.pre.html',
        '_16.6.pre.html',
        '_16.7.pre.html',
        '_16.8.pre.html',
        '_16.9.pre.html',
        '_16.10.pre.html',
        '_16.11.pre.html',
        '_16.12.pre.html',
        '_16.13.pre.html',
        '_16.14.pre.html',
        '_16.15.pre.html',
        '_16.16.pre.html',
        '_16.17.pre.html',
        '_16.18.pre.html',
        '_16.19.pre.html',
        '_16.20.pre.html',
        '_16.21.pre.html',
        '_16.22.pre.html',
        '_16.23.pre.html',
        '_16.24.pre.html',
        '_16.25.pre.html',
        '_16.26.pre.html',
        '_16.27.pre.html',
        '_16.28.pre.html',
        '_16.29.pre.html',
        '_16.30.pre.html',
        '_16.31.pre.html',
        '_16.32.pre.html',
        '_17.pre.html',
        '_17.pre.html.1.html',
        '_18.pre.html',
        'combine.html',
        'main.html',
        'main.html.bs4.html',
        'main.html.stage.1.html',
        'main.html.stage.2.html',
        'main.image.reference.html',
        'main.orig.html',
        'main.reference.html',
        'original_page.html',
        'page.html',
        'page.html.html',
        'pup.pre.html',
        '_raw.html',
        '_1.5.pre.html',
        '_14.2.2.pre.html',
        '_16.100.pre.html',
        '_16.101.pre.html',
        '_16.102.pre.html',
        '_16.103.pre.html',
        '_16.104.pre.html',
        '_16.105.pre.html',
        '_16.106.pre.html',
        '_16.107.pre.html',
        '_16.108.pre.html',
        '_16.109.pre.html',
        '_16.110.pre.html',
        '_16.111.pre.html',
        '_16.112.pre.html',
        '_16.113.pre.html',
        '_16.114.pre.html',
        '_16.115.pre.html',
        '_16.116.pre.html',
        '_16.117.pre.html',
        '_16.118.pre.html',
        '_16.119.pre.html',
        '_16.120.pre.html',
        '_16.121.pre.html',
        '_16.122.pre.html',
        '_16.123.pre.html',
        '_16.124.pre.html',
        '_16.125.pre.html',
        '_16.126.pre.html',
        '_16.127.pre.html',
        '_16.128.pre.html',
        '_16.129.pre.html',
        '_16.130.pre.html',
        '_16.131.pre.html',
        '_16.132.pre.html',
        '_16.133.pre.html',
        '_16.134.pre.html',
        '_16.135.pre.html',
        '_16.136.pre.html',
        '_16.137.pre.html',
        '_16.138.pre.html',
        '_16.139.pre.html',
        '_16.140.pre.html',
        '_16.141.pre.html',
        '_16.142.pre.html',
        '_16.143.pre.html',
        '_16.144.pre.html',
        '_16.145.pre.html',
        '_16.146.pre.html',
        '_16.147.pre.html',
        '_16.148.pre.html',
        '_16.149.pre.html',
        '_16.150.pre.html',
        '_16.151.pre.html',
        '_16.152.pre.html',
        '_16.153.pre.html',
        '_16.154.pre.html',
        '_16.155.pre.html',
        '_16.156.pre.html',
        '_16.157.pre.html',
        '_16.158.pre.html',
        '_16.159.pre.html',
        '_16.160.pre.html',
        '_16.161.pre.html',
        '_16.162.pre.html',
        '_16.163.pre.html',
        '_16.164.pre.html',
        '_16.165.pre.html',
        '_16.166.pre.html',
        '_16.167.pre.html',
        '_16.168.pre.html',
        '_16.169.pre.html',
        '_16.170.pre.html',
        '_16.171.pre.html',
        '_16.172.pre.html',
        '_16.173.pre.html',
        '_16.174.pre.html',
        '_16.175.pre.html',
        '_16.176.pre.html',
        '_16.177.pre.html',
        '_16.178.pre.html',
        '_16.179.pre.html',
        '_16.180.pre.html',
        '_16.181.pre.html',
        '_16.182.pre.html',
        '_16.183.pre.html',
        '_16.184.pre.html',
        '_16.185.pre.html',
        '_16.186.pre.html',
        '_16.187.pre.html',
        '_16.188.pre.html',
        '_16.189.pre.html',
        '_16.190.pre.html',
        '_16.191.pre.html',
        '_16.192.pre.html',
        '_16.193.pre.html',
        '_16.194.pre.html',
        '_16.195.pre.html',
        '_16.196.pre.html',
        '_16.197.pre.html',
        '_16.198.pre.html',
        '_16.199.pre.html',
        '_16.200.pre.html',
        '_16.201.pre.html',
        '_16.202.pre.html',
        '_16.203.pre.html',
        '_16.204.pre.html',
        '_16.205.pre.html',
        '_16.206.pre.html',
        '_16.207.pre.html',
        '_16.208.pre.html',
        '_16.209.pre.html',
        '_16.210.pre.html',
        '_16.211.pre.html',
        '_16.212.pre.html',
        '_16.213.pre.html',
        '_16.214.pre.html',
        '_16.215.pre.html',
        '_16.216.pre.html',
        '_16.217.pre.html',
        '_16.218.pre.html',
        '_16.219.pre.html',
        '_16.220.pre.html',
        '_16.221.pre.html',
        '_16.222.pre.html',
        '_16.223.pre.html',
        '_16.224.pre.html',
        '_16.225.pre.html',
        '_16.226.pre.html',
        '_16.227.pre.html',
        '_16.228.pre.html',
        '_16.229.pre.html',
        '_16.230.pre.html',
        '_16.231.pre.html',
        '_16.232.pre.html',
        '_16.233.pre.html',
        '_16.234.pre.html',
        '_16.235.pre.html',
        '_16.236.pre.html',
        '_16.237.pre.html',
        '_16.238.pre.html',
        '_16.239.pre.html',
        '_16.240.pre.html',
        '_16.241.pre.html',
        '_16.242.pre.html',
        '_16.243.pre.html',
        '_16.244.pre.html',
        '_16.245.pre.html',
        '_16.33.pre.html',
        '_16.34.pre.html',
        '_16.35.pre.html',
        '_16.36.pre.html',
        '_16.37.pre.html',
        '_16.38.pre.html',
        '_16.39.pre.html',
        '_16.40.pre.html',
        '_16.41.pre.html',
        '_16.42.pre.html',
        '_16.43.pre.html',
        '_16.44.pre.html',
        '_16.45.pre.html',
        '_16.46.pre.html',
        '_16.47.pre.html',
        '_16.48.pre.html',
        '_16.49.pre.html',
        '_16.50.pre.html',
        '_16.51.pre.html',
        '_16.52.pre.html',
        '_16.53.pre.html',
        '_16.54.pre.html',
        '_16.55.pre.html',
        '_16.56.pre.html',
        '_16.57.pre.html',
        '_16.58.pre.html',
        '_16.59.pre.html',
        '_16.60.pre.html',
        '_16.61.pre.html',
        '_16.62.pre.html',
        '_16.63.pre.html',
        '_16.64.pre.html',
        '_16.65.pre.html',
        '_16.66.pre.html',
        '_16.67.pre.html',
        '_16.68.pre.html',
        '_16.69.pre.html',
        '_16.70.pre.html',
        '_16.71.pre.html',
        '_16.72.pre.html',
        '_16.73.pre.html',
        '_16.74.pre.html',
        '_16.75.pre.html',
        '_16.76.pre.html',
        '_16.77.pre.html',
        '_16.78.pre.html',
        '_16.79.pre.html',
        '_16.80.pre.html',
        '_16.81.pre.html',
        '_16.82.pre.html',
        '_16.83.pre.html',
        '_16.84.pre.html',
        '_16.85.pre.html',
        '_16.86.pre.html',
        '_16.87.pre.html',
        '_16.88.pre.html',
        '_16.89.pre.html',
        '_16.90.pre.html',
        '_16.91.pre.html',
        '_16.92.pre.html',
        '_16.93.pre.html',
        '_16.94.pre.html',
        '_16.95.pre.html',
        '_16.96.pre.html',
        '_16.97.pre.html',
        '_16.98.pre.html',
        '_16.99.pre.html',
        '_17.0.pre.html',
        '_17.1.pre.html',
        '_17.10.pre.html',
        '_17.11.pre.html',
        '_17.12.pre.html',
        '_17.13.pre.html',
        '_17.14.pre.html',
        '_17.15.pre.html',
        '_17.16.pre.html',
        '_17.17.pre.html',
        '_17.18.pre.html',
        '_17.19.pre.html',
        '_17.2.pre.html',
        '_17.20.pre.html',
        '_17.21.pre.html',
        '_17.22.pre.html',
        '_17.23.pre.html',
        '_17.24.pre.html',
        '_17.3.pre.html',
        '_17.4.pre.html',
        '_17.5.pre.html',
        '_17.6.pre.html',
        '_17.7.pre.html',
        '_17.8.pre.html',
        '_17.9.pre.html'
    ]

    files = [f for f in os.listdir(dest_folder) if os.path.isfile(os.path.join(dest_folder, f))]
    for f in files:
        if f in ignore_files:
            os.system('rm ' + os.path.join(dest_folder, f))
            continue

        html = open(os.path.join(dest_folder, f), 'r')
        soup = BeautifulSoup(html, 'html.parser')
        canonical_tag = soup.find('link', {'rel':'canonical'})
        if canonical_tag:
            url = canonical_tag['href']
            idx = -1
            for i in range(0, 3):
                idx = url.find('/', idx + 1)
            
            path = url[idx + 1:]
            if len(path) > 0 and path[-1] == '/':
                    path = path[:-1][:path.rindex('/') + 1]
            idx = 1
            while True:
                idx = path.find('/', idx + 1)
                if idx == -1 or idx == len(path):
                    break
                if not os.path.exists(os.path.join(dest_folder, path[:idx])):
                    cmd = 'mkdir ' + os.path.join(dest_folder, path[:idx])
                    os.system(cmd)
            
            if '/' in path:
                to_remove = path[:path.rindex('/') + 1].replace('/','-')
            else:
                to_remove = path
            dest = (path[:path.rindex('/') + 1] if '/' in path else path) + f.replace(to_remove,'')
            mv_cmd = 'mv ' + os.path.join(dest_folder, f) + ' ' + os.path.join(dest_folder, dest)
            os.system(mv_cmd)

if __name__ == '__main__':
    main()
